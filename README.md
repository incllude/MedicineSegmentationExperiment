# Отчет по эксперименту оценки положения 3D КТ-снимка в пространстве на итоговый результат сегментации

## Введение

В данном эксперименте рассматривается гипотеза о том, что модели машинного обучения, используемые для сегментации медицинских изображений, могут переобучаться под конкретное положение объекта в пространстве. Это означает, что модели могут демонстрировать высокую точность сегментации на данных с фиксированной ориентацией объекта, но значительно терять в качестве при изменении его положения.

Для проверки гипотезы были проведены эксперименты по моделированию объектов в различных ориентациях в пространстве и сравнение качества сегментации между экспериментами. Для сегментации использовалась предварительно обученная модель $\text{Unetr}$, которая была выбрана благодаря доступной официальной реализации и предобученным весам. Модель была обучена на наборе данных $\text{BTCV}$, содержащем КТ-снимки и сегментации органов брюшной полости. Все изображения в наборе данных были зафиксированы в одном положении, что означает одинаковую ориентацию всех данных. Для экспериментов применялась только валидационная выборка из этого набора данных. В процессе обучения к этим объемам случайным образом применялись следующие искажения:

- зеркальное отражение по одной из осей,
- поворот на 90 градусов относительно одной из трех основных осей,
- изменение интенсивности пикселей изображения.

Важно отметить, что в оригинальной статье авторы дополнительно использовали закрытый набор данных, что привело к более высоким результатам сегментации по сравнению с теми, которые можно получить с использованием только общедоступных весов.

## Моделирование различных положений объекта в пространстве

Для моделирования различных ориентаций объекта в трёхмерном пространстве была проведена серия из 3 экспериментов, включающих повороты изображений на случайные углы вокруг произвольных осей, проходящих через центр изображения. Эксперименты различаются диапазоном углов поворота:

| Эксперимент | Диапазон углов поворота | Число поворотов  | Описание                |
|-------------|-------------------------|------------------|-------------------------|
| 1           | $(0^\circ, 1^\circ]$    | 51               | Очень малые повороты    |
| 2           | $(1^\circ, 5^\circ]$    | 101              | Малые повороты          |
| 3           | $(5^\circ, 20^\circ]$   | 201              | Значимые повороты       |

Для каждого эксперимента было создано свое количество поворотов. Их количество отличается, так как больший диапазон угла поворота требует большего количества поворотов для лучшего покрытия всех возможных ориентаций. Каждый поворот описывается вектором вращения $\vec{v} = \theta \cdot \vec{e}$, где $\theta$ — угол поворота, а $\vec{e}$ — единичный вектор направления оси вращения. Вектор $\vec{e}$ генерировался путем нормализации случайного трёхмерного вектора, равномерно распределённого в диапазоне $[-1, 1]^3$. Угол $\theta$ выбирался из равномерного распределения на заданном для каждого эксперимента диапазоне.

### Реализация

Повороты изображений моделировались с помощью аффинных преобразований, реализованных с использованием объекта `Affine` из библиотеки `Monai`. Для поворота изображения использовалась интерполяция `bilinear`, а для карты классов — `nearest`. Аффинные преобразования основывались на матрицах, полученных с помощью функции `Rotation.from_rotvec` из библиотеки `scipy` и сформированных на основе векторов вращения из экспериментов.

Особое внимание следует уделить этапу применения операции поворота в процессе обработки данных. В одной из стадий обработки данных авторы выполняют ресэмплинг, чтобы привести разрешение изображений к масштабу: расстояние между пикселями по осям X и Y устанавливается на 1.5 мм, а по оси Z — на 2 мм. Поворот необходимо выполнять только после этого этапа, поскольку его применение до ресэмплинга может привести к несоответствию разрешения изображения, что не соответствует условиям, на которых обучалась нейронная сеть. Также при повороте изображения возможна потеря информации из-за выхода за границы, поэтому к каждому объему добавлялась рамка размера, предотвращающего любые возможные потери такого рода (размер сохранялся между экспериментами). В связи со всем с этим операции добавления рамки и поворота были включены в процесс обработки данных сразу после шага ресэмплинга.

Для оценки степени потери информации при поворотах были проведены дополнительные эксперименты. В этих экспериментах к изображениям и картам классов применялись те же аффинные преобразования, что и в основном эксперименте, после чего выполнялись обратные преобразования. Затем вычислялась ошибка между исходными и восстановленными изображениями. В качестве метрики для измерения расхождения между исходным и восстановленным изображением использовалась MAPE, считавшаяся только по ненулевым вокселям изображения, а для оценки совпадения карт классов применялась метрика Dice. Обратные преобразования выполнялись с использованием функции `Affine.inverse` из библиотеки `Monai`.

### Результаты экспериментов по оценке потери информации при поворотах

Результаты экспериментов по оценке потери информации при поворотах представлены в следующей таблице:

| Эксперимент | Диапазон углов | Число поворотов | Среднее MAPE для изображений | Средний Dice для карт классов |
|---|-------------------------------|-----|------------------------------|-------------------------------|
| 1 | $(0^\circ, 1^\circ]$          | 51  | 0.0127                       | 0.999                         |
| 2 | $(1^\circ, 5^\circ]$          | 101 | 0.0147                       | 0.996                         |
| 3 | $(5^\circ, 20^\circ]$         | 201 | 0.0151                       | 0.986                         |

Как видно из таблицы, даже при небольших углах поворота (0°–1°) наблюдается незначительная потеря информации. С увеличением угла поворота потеря информации возрастает, что отражается в увеличении MAPE для изображений и уменьшении Dice для карт классов. Тем не менее, даже при значительных поворотах (5°–20°) потеря информации остается относительно небольшой, что свидетельствует о корректности применяемого метода поворота изображений.

## Оценка влияния положения объекта в пространстве на результат сегментации

Оценка влияния положения объекта в пространстве на результат сегментации проводилась на основе данных, полученных из экспериментов 1–3. Модель сегментировала повернутые изображения из каждого эксперимента, и для каждого набора данных был рассчитан средний и медианный Dice между повернутыми истинными картами классов и сегментацией на повернутых изображениях. Также были подсчитаны метрики Dice на оригинальных, неповернутых изображениях как с добавлением рамки, так и без нее. Все значения указаны в сравнительной таблице:

| Описание | Диапазон углов | Средний Dice для карт классов | Медианный Dice для карт классов |
|-----------------------------------|-------------------------------|-------|-------------------------------|
| Оригинальные изображения          | —                             | 0.774 | 0.776                         |
| Оригинальные изображения с рамкой | —                             | 0.769 | 0.775                         |
| Эксперимент 1                     | $[0^\circ, 1^\circ]$          | 0.756 | 0.764                         |
| Эксперимент 2                     | $[1^\circ, 5^\circ]$          | 0.733 | 0.740                         |
| Эксперимент 3                     | $[5^\circ, 20^\circ]$         | 0.698 | 0.706                         |

Также были созданы изображения для визуального сравнения сегментации модели на повернутых и оригинальных снимках. Эти изображения отображают 4 среза, где наблюдаются наибольшие различия между сегментацией на оригинальных и повернутых данных, обведенные красной рамкой. Для анализа использовались повернутые изображения, соответствующие медианному значению Dice в каждом эксперименте. Пример такого изображения для второго эксперимента приведен ниже:

Сравнение сегментации для эксперимента 1 с очень малыми поворотами:
![](data/0_1/slices_comparison_from_0_to_1.png)

Сравнение сегментации для эксперимента 2 с малыми поворотами:
![](data/1_5/slices_comparison_from_1_to_5.png)

Сравнение сегментации для эксперимента 3 с значительными поворотами:
![](data/5_20/slices_comparison_from_5_to_20.png)

## Выводы

Результаты проведённых экспериментов указывают на то, что изменение угла поворота 3D КТ-снимков может оказывать влияние на качество сегментации, что подтверждает выдвинутую гипотезу. Показатель Dice в среднем снижается с 0.756 при незначительных углах поворота $[0^\circ, 1^\circ]$ относительной произвольной прямой, проходящей через центр изображения, до 0.698 при более существенных углах $[5^\circ, 20^\circ]$. Тем не менее, визуальный анализ демонстрирует, что степень этого влияния не велика. Следовательно, можно сделать вывод, что модели сегментации медицинских изображений могут проявлять некоторое переобучение относительно конкретного пространственного расположения сканируемого объекта.
