# Отчет по эксперименту оценки положения 3D КТ-снимка в пространстве на итоговый результат сегментации

## Введение

В данном эксперименте рассматривается гипотеза о том, что модели машинного обучения, используемые для сегментации медицинских изображений, могут переобучаться под конкретное положение объекта в пространстве. Это означает, что модели могут демонстрировать высокую точность сегментации на данных с фиксированной ориентацией объекта, но значительно терять в качестве при изменении его положения.

Для проверки гипотезы были проведены эксперименты по моделированию объектов в различных ориентациях в пространстве и сравнение качества сегментации между экспериментами. Для сегментации использовалась предварительно обученная модель $\text{Unetr}$, которая была выбрана благодаря доступной официальной реализации и предобученным весам. Модель была обучена на наборе данных $\text{BTCV}$, содержащем КТ-снимки и сегментации органов брюшной полости. Все изображения в наборе данных были зафиксированы в одном положении, что означает одинаковую ориентацию всех данных. Для экспериментов применялась только валидационная выборка из этого набора данных. В процессе обучения к этим объемам случайным образом применялись следующие искажения:

- зеркальное отражение по одной из осей,
- поворот на 90 градусов относительно одной из трех основных осей,
- изменение интенсивности пикселей изображения.

Важно отметить, что в оригинальной статье авторы дополнительно использовали закрытый набор данных, что привело к более высоким результатам сегментации по сравнению с теми, которые можно получить с использованием только общедоступных весов.

## Моделирование различных положений объекта в пространстве

Для моделирования различных ориентаций объекта в трёхмерном пространстве была проведена серия из 5 экспериментов, включающих повороты изображений на случайные углы вокруг произвольных осей, проходящих через центр изображения. Эксперименты различаются диапазоном углов поворота:

| Эксперимент | Диапазон углов поворота | Число поворотов  | Описание                |
|-------------|-------------------------|------------------|-------------------------|
| 1           | $[0^\circ, 1^\circ]$    | 51               | Очень малые повороты    |
| 2           | $[1^\circ, 5^\circ]$    | 101              | Малые повороты          |
| 3           | $[5^\circ, 20^\circ]$   | 201              | Значимые повороты       |
| 4           | $[20^\circ, 45^\circ]$  | 201              | Большие повороты        |
| 5           | $[45^\circ, 180^\circ]$ | 201              | Сверхбольшие повороты  |

Для каждого эксперимента было создано свое количество поворотов. Их количество отличается, так как больший диапазон угла поворота требует большего количества поворотов для лучшего покрытия всех возможных ориентаций. Каждый поворот описывается вектором вращения $\vec{v} = \theta \cdot \vec{e}$, где $\theta$ — угол поворота, а $\vec{e}$ — единичный вектор направления оси вращения. Вектор $\vec{e}$ генерировался путем нормализации случайного трёхмерного вектора, равномерно распределённого в диапазоне $[-1, 1]^3$. Угол $\theta$ выбирался из равномерного распределения на заданном для каждого эксперимента диапазоне.

### Реализация

Повороты изображений моделировались с помощью аффинных преобразований, реализованных с использованием объекта `Affine` из библиотеки `Monai`. Для поворота изображения использовалась интерполяция `bilinear`, а для карты классов — `nearest`. Аффинные преобразования основывались на матрицах, полученных с помощью функции `Rotation.from_rotvec` из библиотеки `scipy` и сформированных на основе векторов вращения из экспериментов.

Особое внимание следует уделить этапу применения операции поворота в процессе обработки данных. В одной из стадий обработки данных авторы выполняют ресэмплинг, чтобы привести разрешение изображений к масштабу: расстояние между пикселями по осям X и Y устанавливается на 1.5 мм, а по оси Z — на 2 мм. Поворот необходимо выполнять только после этого этапа, поскольку его применение до ресэмплинга может привести к несоответствию разрешения изображения, что не соответствует условиям, на которых обучалась нейронная сеть. Также при повороте изображения возможна потеря информации из-за выхода за границы, поэтому к каждому объему добавлялась рамка размера, предотвращающего любые возможные потери такого рода (размер сохранялся между экспериментами). В связи со всем с этим операции добавления рамки и поворота были включены в процесс обработки данных сразу после шага ресэмплинга.

Для оценки степени потери информации при поворотах были проведены дополнительные эксперименты. В этих экспериментах к изображениям и картам классов применялись те же аффинные преобразования, что и в основном эксперименте, после чего выполнялись обратные преобразования. Затем вычислялась ошибка между исходными и восстановленными изображениями. В качестве метрики для измерения расхождения между исходным и восстановленным изображением использовалась MAPE, считавшаяся только по ненулевым вокселям изображения, а для оценки совпадения карт классов применялась метрика Dice. Обратные преобразования выполнялись с использованием функции `Affine.inverse` из библиотеки `Monai`.

### Оценка влияния размера рамки на качество сегментации

В ходе работы было выявлено, что размер добавляемой рамки, которая используется для предотвращения потери информации при повороте изображений, может влиять на качество сегментации. Для исследований была взята модель $\text{Unetr}$, основанная на архитектуре трансформера. Она выполняет сегментацию изображения с использованием скользящего окна размером $96 \times 96 \times 96$ с 50%-ным перекрытием по площади, где каждая непересекающаяся часть размером $16 \times 16 \times 16$ рассматривается как токен, подающийся в трансформер.

Основная гипотеза состояла в том, что некратные значения размера рамки $16$ могут негативно сказываться на качестве сегментации. Для проверки данной гипотезы были проведены эксперименты, в которых сегментация выполнялась для неповернутых изображений с различными размерами рамок. Рассматривались два набора размеров рамок: $\{0, 4, 8, 12, 16, 20\}$ и $\{96, 100, 104, 108, 112, 116\}$. Это позволило проанализировать не только влияние рамки, но и оценить возможное влияние скользящего окна на результаты сегментации.

Результаты экспериментов представлены в таблице, где жирным шрифтом выделены показатели для рамок, размеры которых кратны $16$.

| Размер рамки | Средний Dice | Средний IoU | Средний Precision | Средний Recall |
| ------------ | ------------ | ----------- | ----------------- | -------------- |
| **0** | **0.774** | **0.651** | **0.818** | **0.918** |
| 4 | 0.706 | 0.562 | 0.670 | 0.912 |
| 8 | 0.708 | 0.566 | 0.692 | 0.911 |
| 12 | 0.713 | 0.574 | 0.688 | 0.909 |
| **16** | **0.799** | **0.680** | **0.868** | **0.916** |
| 20 | 0.705 | 0.561 | 0.656 | 0.909 |
| **96** | **0.768** | **0.648** | **0.846** | **0.906** |
| 100 | 0.707 | 0.564 | 0.669 | 0.907 |
| 104 | 0.711 | 0.571 | 0.701 | 0.902 |
| 108 | 0.716 | 0.576 | 0.702 | 0.897 |
| **112** | **0.772** | **0.647** | **0.843** | **0.902** |
| 116 | 0.699 | 0.554 | 0.643 | 0.902 |

Анализ метрик Dice, IoU и Precision демонстрирует, что использование рамок с размерами, не кратными $16$, действительно приводит к снижению качества сегментации. При этом, параметры скользящего окна не оказали значимого влияния на результат сегментации. Исходя из этих наблюдений, в дальнейших экспериментах было принято решение использовать только размеры рамки, кратные $16$, чтобы гарантировать стабильное качество сегментации.

### Результаты экспериментов по оценке потери информации при поворотах

Результаты экспериментов по оценке потери информации при поворотах представлены в следующей таблице:

| Описание | Диапазон углов | Минимальный MAPE для изображений | Средний MAPE для изображений | Максимальный MAPE для изображений | Минимальный Dice для карт классов | Средний Dice для карт классов | Максимальный Dice для карт классов |
| -------- | -------------- | -------------------------------- | ---------------------------- | --------------------------------- | --------------------------------- | ----------------------------- | ---------------------------------- |
| Эксперимент 1 | $[0^\circ, 1^\circ]$ | 0.0 | 0.022 | 0.03 | 0.999 | 0.999 | 1.0 |
| Эксперимент 2 | $[1^\circ, 5^\circ]$ | 0.016 | 0.026 | 0.029 | 0.995 | 0.996 | 0.997 |
| Эксперимент 3 | $[5^\circ, 20^\circ]$ | 0.018 | 0.026 | 0.03 | 0.983 | 0.986 | 0.988 |
| Эксперимент 4 | $[20^\circ, 45^\circ]$ | 0.018 | 0.031 | 0.062 | 0.969 | 0.973 | 0.977 |
| Эксперимент 5 | $[45^\circ, 180^\circ]$ | 0.018 | 0.045 | 0.101 | 0.967 | 0.972 | 0.975 |

Как видно из таблицы, даже при небольших углах поворота $[0^\circ, 1^\circ]$ может быть потеря информации. С увеличением угла поворота потеря информации возрастает, что отражается в увеличении MAPE для изображений и уменьшении Dice для карт классов. Тем не менее, даже при сверхбольших поворотах в диапазоне $[45^\circ, 180^\circ]$ в среднем потеря информации остается на удобоваримом уровне, поэтому можно говорить о корректности применяемого метода поворота изображений.

## Оценка влияния положения объекта в пространстве на результат сегментации

Оценка влияния положения объекта в пространстве на результат сегментации проводилась на основе данных, полученных из экспериментов 1–5. Модель сегментировала повернутые изображения из каждого эксперимента, и для каждого набора данных были Dice, IoU, Precision и Recall между повернутыми истинными картами классов и сегментацией на повернутых изображениях. Все метрики считались в режиме макро, то есть усреднялись среди всех классов, исключая фон. Также были метрики были подсчитаны на оригинальных, неповернутых изображениях как с добавлением рамки, так и без нее. Для каждой из метрики были подсчитаны среднее, стандартное отклонение, минимум, максимум, нижняя и нижняя границы уса, а также 25-й, 50-й и 75-й процентили. Все эти значения выводились в таблицу (каждую для своей метрики). Дополнительно значения визуализировались с помощью ящика с усами (boxplot) (выбросы строятся на основе межквартильного размаха с коэффициентом 1,5) Все значения указаны в сравнительной таблице:

### Dice:

#### Таблица
| Описание | Диапазон углов | Средний Dice | Стандартное отклонение Dice | Минимум Dice | Нижняя граница уса Dice | 25-й процентиль Dice | Медиана Dice | 75-й процентиль Dice | Верхняя граница уса Dice | Максимум Dice |
| -------- | -------------- | ------------ | --------------------------- | ------------ | ----------------------- | -------------------- | ------------ | -------------------- | ------------------------ | ------------- |
| Оригинальные изображения | — | 0.774 | 0.032 | 0.724 | 0.724 | 0.757 | 0.771 | 0.795 | 0.676 | 0.823 |
| Оригинальные изображения с рамкой | — | 0.799 | 0.019 | 0.762 | 0.775 | 0.794 | 0.802 | 0.807 | 0.823 | 0.824 |
| Эксперимент 1 | $[0^\circ, 1^\circ]$ | 0.774 | 0.028 | 0.711 | 0.711 | 0.757 | 0.777 | 0.792 | 0.824 | 0.824 |
| Эксперимент 2 | $[1^\circ, 5^\circ]$ | 0.735 | 0.037 | 0.638 | 0.638 | 0.709 | 0.742 | 0.761 | 0.824 | 0.817 |
| Эксперимент 3 | $[5^\circ, 20^\circ]$ | 0.69 | 0.035 | 0.58 | 0.606 | 0.671 | 0.696 | 0.715 | 0.781 | 0.781 |
| Эксперимент 4 | $[20^\circ, 45^\circ]$ | 0.614 | 0.066 | 0.41 | 0.436 | 0.573 | 0.623 | 0.664 | 0.781 | 0.75 |
| Эксперимент 5 | $[45^\circ, 180^\circ]$ | 0.318 | 0.115 | 0.098 | 0.098 | 0.228 | 0.292 | 0.395 | 0.646 | 0.676 |

#### Boxplot
![](data/dice_boxplot.png)

### IoU:

#### Таблица
| Описание | Диапазон углов | Средний IoU | Стандартное отклонение IoU | Минимум IoU | Нижняя граница уса IoU | 25-й процентиль IoU | Медиана IoU | 75-й процентиль IoU | Верхняя граница уса IoU | Максимум IoU |
| -------- | -------------- | ----------- | -------------------------- | ----------- | ---------------------- | ------------------- | ----------- | ------------------- | ----------------------- | ------------ |
| Оригинальные изображения | — | 0.651 | 0.038 | 0.594 | 0.594 | 0.636 | 0.64 | 0.673 | 0.676 | 0.712 |
| Оригинальные изображения с рамкой | — | 0.68 | 0.024 | 0.635 | 0.657 | 0.677 | 0.683 | 0.69 | 0.71 | 0.714 |
| Эксперимент 1 | $[0^\circ, 1^\circ]$ | 0.647 | 0.034 | 0.571 | 0.571 | 0.625 | 0.649 | 0.669 | 0.714 | 0.714 |
| Эксперимент 2 | $[1^\circ, 5^\circ]$ | 0.598 | 0.042 | 0.494 | 0.494 | 0.568 | 0.602 | 0.626 | 0.712 | 0.702 |
| Эксперимент 3 | $[5^\circ, 20^\circ]$ | 0.549 | 0.036 | 0.44 | 0.466 | 0.53 | 0.556 | 0.573 | 0.637 | 0.66 |
| Эксперимент 4 | $[20^\circ, 45^\circ]$ | 0.476 | 0.062 | 0.286 | 0.307 | 0.437 | 0.482 | 0.523 | 0.652 | 0.614 |
| Эксперимент 5 | $[45^\circ, 180^\circ]$ | 0.227 | 0.091 | 0.057 | 0.057 | 0.157 | 0.205 | 0.285 | 0.477 | 0.533 |

#### Boxplot
![](data/iou_boxplot.png)

### Precision:

#### Таблица
| Описание | Диапазон углов | Средний Precision | Стандартное отклонение Precision | Минимум Precision | Нижняя граница уса Precision | 25-й процентиль Precision | Медиана Precision | 75-й процентиль Precision | Верхняя граница уса Precision | Максимум Precision |
| -------- | -------------- | ----------------- | -------------------------------- | ----------------- | ---------------------------- | ------------------------- | ----------------- | ------------------------- | ----------------------------- | ------------------ |
| Оригинальные изображения | — | 0.818 | 0.079 | 0.719 | 0.719 | 0.742 | 0.828 | 0.891 | 0.533 | 0.907 |
| Оригинальные изображения с рамкой | — | 0.868 | 0.063 | 0.772 | 0.772 | 0.819 | 0.883 | 0.918 | 0.907 | 0.945 |
| Эксперимент 1 | $[0^\circ, 1^\circ]$ | 0.802 | 0.087 | 0.641 | 0.641 | 0.732 | 0.795 | 0.873 | 0.945 | 0.945 |
| Эксперимент 2 | $[1^\circ, 5^\circ]$ | 0.715 | 0.088 | 0.574 | 0.574 | 0.643 | 0.698 | 0.766 | 0.945 | 0.936 |
| Эксперимент 3 | $[5^\circ, 20^\circ]$ | 0.684 | 0.072 | 0.57 | 0.57 | 0.623 | 0.673 | 0.728 | 0.887 | 0.905 |
| Эксперимент 4 | $[20^\circ, 45^\circ]$ | 0.658 | 0.092 | 0.449 | 0.449 | 0.588 | 0.649 | 0.713 | 0.901 | 0.864 |
| Эксперимент 5 | $[45^\circ, 180^\circ]$ | 0.513 | 0.127 | 0.267 | 0.267 | 0.407 | 0.498 | 0.609 | 0.864 | 0.852 |

#### Boxplot
![](data/precision_boxplot.png)

### Recall:

#### Таблица
| Описание | Диапазон углов | Средний Recall | Стандартное отклонение Recall | Минимум Recall | Нижняя граница уса Recall | 25-й процентиль Recall | Медиана Recall | 75-й процентиль Recall | Верхняя граница уса Recall | Максимум Recall |
| -------- | -------------- | -------------- | ----------------------------- | -------------- | ------------------------- | ---------------------- | -------------- | ---------------------- | -------------------------- | --------------- |
| Оригинальные изображения | — | 0.918 | 0.016 | 0.89 | 0.903 | 0.916 | 0.917 | 0.924 | 0.852 | 0.945 |
| Оригинальные изображения с рамкой | — | 0.916 | 0.012 | 0.901 | 0.901 | 0.911 | 0.915 | 0.917 | 0.927 | 0.941 |
| Эксперимент 1 | $[0^\circ, 1^\circ]$ | 0.91 | 0.013 | 0.883 | 0.891 | 0.904 | 0.909 | 0.912 | 0.924 | 0.941 |
| Эксперимент 2 | $[1^\circ, 5^\circ]$ | 0.907 | 0.015 | 0.864 | 0.883 | 0.9 | 0.907 | 0.911 | 0.928 | 0.935 |
| Эксперимент 3 | $[5^\circ, 20^\circ]$ | 0.886 | 0.025 | 0.765 | 0.845 | 0.878 | 0.891 | 0.899 | 0.932 | 0.926 |
| Эксперимент 4 | $[20^\circ, 45^\circ]$ | 0.834 | 0.051 | 0.637 | 0.711 | 0.807 | 0.846 | 0.872 | 0.926 | 0.916 |
| Эксперимент 5 | $[45^\circ, 180^\circ]$ | 0.627 | 0.11 | 0.325 | 0.351 | 0.562 | 0.626 | 0.702 | 0.913 | 0.896 |

#### Boxplot
![](data/recall_boxplot.png)

### Визуальное сравнение

Также были созданы изображения для визуального сравнения сегментации модели на повернутых и оригинальных снимках. Эти изображения отображают срезы, где наблюдаются наибольшие различия между сегментацией на оригинальных и повернутых данных, обведенные красной рамкой. Для анализа использовались повернутые изображения, соответствующие медианному значению Dice в каждом эксперименте. Пример такого изображения для второго эксперимента приведен ниже:

#### Сравнение сегментации для эксперимента 1 с очень малыми поворотами:
![](data/0_1/slices_comparison_add_metrics_from_0_to_1.png)

#### Сравнение сегментации для эксперимента 2 с малыми поворотами:
![](data/1_5/slices_comparison_add_metrics_from_1_to_5.png)

#### Сравнение сегментации для эксперимента 3 с значительными поворотами:
![](data/5_20/slices_comparison_add_metrics_from_5_to_20.png)

#### Сравнение сегментации для эксперимента 4 с большими поворотами:
![](data/20_45/slices_comparison_add_metrics_from_20_to_45.png)

#### Сравнение сегментации для эксперимента 5 с сверхбольшими поворотами:
![](data/45_180/slices_comparison_add_metrics_from_45_to_180.png)

## Выводы

Результаты экспериментов подтверждают влияние угла поворота 3D КТ-снимков на качество сегментации, что соответствует выдвинутой гипотезе. Все метрики (минимум, максимум, среднее и т.д.) демонстрируют закономерное снижение с увеличением угла поворота. Если не учитывать последний эксперимент со сверхбольшими поворотами, то видна интересная закономерность: при очень малых и малых углах поворота Precision падает быстрее, чем Recall, в то время как для больших углов характерно падение Recall, в то время как Precision падает, но не так быстро как при меньших углах. При сверхбольших углах наблюдается самая большая деградация метрик. В результате постоянного ухудшения Precision и Recall метрики Dice и IoU, последовательно и заметно падают с увеличением угла поворота.

Графики показывают, что минимальные значения метрик снижаются быстрее, чем максимальные, хотя максимумы Precision и Recall остаются достаточно высокими во всех экспериментах. Минимальные же значения снижаются до уровней ниже 0.3 и 0.4 соответственно.

Визуальное сравнение сегментаций подтверждает падение метрик. Даже при малых и значимых углах поворота модель может не сегментировать некоторые объекты (срез 256 во 2-м эксперименте, срезы 286 и 260 в 3-м), а также неправильно сегментировать части органов (срез 218 во 2-м, срезы 286 и 260 в 3-м экспериментах). Эти тенденции проявляются и в 1-м эксперименте при небольших углах поворота, но менее выражены. При больших углах проблемы сегментации становятся более заметными, а при сверхбольших углах поворота деградация достигает критических уровней.
